name: Deploy Laravel

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üöÄ Conectar via SSH e fazer deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            set -e

            echo "‚û°Ô∏è Entrando na pasta do projeto"
            cd /web

            echo "‚û°Ô∏è Atualizando branch main"
            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            echo "‚û°Ô∏è Instalando depend√™ncias"
            composer install --no-interaction --prefer-dist --optimize-autoloader

            echo "‚û°Ô∏è Rodando migra√ß√µes"
            php artisan migrate --force

            echo "‚û°Ô∏è Limpando e otimizando caches"
            php artisan config:clear
            php artisan config:cache
            php artisan route:clear
            php artisan route:cache
            php artisan view:clear
            php artisan view:cache
            php artisan cache:clear
            php artisan optimize:clear
            php artisan optimize

            echo "‚û°Ô∏è Verificando e corrigindo permiss√µes"
            chmod -R 755 storage/
            chmod -R 755 bootstrap/cache/
            chown -R www-data:www-data storage/ || echo "N√£o foi poss√≠vel alterar owner do storage"
            chown -R www-data:www-data bootstrap/cache/ || echo "N√£o foi poss√≠vel alterar owner do cache"

            echo "‚û°Ô∏è Verificando arquivo .env"
            if [ ! -f .env ]; then
                echo "‚ö†Ô∏è  Arquivo .env n√£o encontrado, criando a partir do .env.example"
                cp .env.example .env || echo "N√£o foi poss√≠vel copiar .env.example"
            fi

            echo "‚û°Ô∏è Gerando chave da aplica√ß√£o se necess√°rio"
            php artisan key:generate --force || echo "N√£o foi poss√≠vel gerar chave"

            echo "‚û°Ô∏è Reiniciando servi√ßo do PHP"
            # Tentar diferentes m√©todos de reiniciar o PHP
            if command -v systemctl &> /dev/null; then
                systemctl restart php8.2-fpm || systemctl restart php8.1-fpm || systemctl restart php-fpm || echo "N√£o foi poss√≠vel reiniciar via systemctl"
            elif command -v service &> /dev/null; then
                service php8.2-fpm restart || service php8.1-fpm restart || service php-fpm restart || echo "N√£o foi poss√≠vel reiniciar via service"
            else
                echo "‚ö†Ô∏è  N√£o foi poss√≠vel reiniciar o PHP automaticamente. Reinicie manualmente."
            fi

            echo "‚û°Ô∏è Verificando status do PHP"
            php -v || echo "PHP n√£o est√° funcionando corretamente"

            echo "‚úÖ Deploy conclu√≠do com sucesso!"

